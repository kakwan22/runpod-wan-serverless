# EXTENDS BASE IMAGE WITH MODELS 
FROM kakwan22/wanrunpod:latest

# Set working directory to ComfyUI
WORKDIR /ComfyUI

# HF token for model downloads
ARG HF_TOKEN
ENV HF_TOKEN=$HF_TOKEN

# Force cache bust for model downloads - v5
RUN echo "Model download cache bust v5"

# Ensure directories exist and clean up any existing models
RUN mkdir -p models/checkpoints models/clip_vision && \
    rm -rf models/checkpoints/* models/clip_vision/* || true

# Download WAN model (check first - 24GB)
RUN cd models/checkpoints && \
    if [ ! -f "wan2.2-i2v-rapid-aio-v10-nsfw.safetensors" ] || [ $(stat -c%s "wan2.2-i2v-rapid-aio-v10-nsfw.safetensors" 2>/dev/null || echo 0) -lt 20000000000 ]; then \
        echo "Downloading WAN 2.2 model..." && \
        hf download --local-dir . Phr00t/WAN2.2-14B-Rapid-AllInOne v10/wan2.2-i2v-rapid-aio-v10-nsfw.safetensors; \
    fi

# Download CLIP Vision model (check first - 1.7GB)
RUN cd models/clip_vision && \
    if [ ! -f "clip_vision_vit_h.safetensors" ] || [ $(stat -c%s "clip_vision_vit_h.safetensors" 2>/dev/null || echo 0) -lt 1000000000 ]; then \
        echo "Downloading CLIP Vision model..." && \
        hf download --local-dir . lllyasviel/misc clip_vision_vit_h.safetensors; \
    fi